
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Filtering service events Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.2">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="../styles/website.css">
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="browsers-mobile-devices.html" />
    
    
    <link rel="prev" href="publications.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../step-by-step/readme.html">
            
                <a href="../step-by-step/readme.html">
            
                    
                    Step by step intro to basic Feathers >>
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../step-by-step/intro/readme.html">
            
                <a href="../step-by-step/intro/readme.html">
            
                    
                    Introduction >>
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1.1" data-path="../step-by-step/intro/not-worry.html">
            
                <a href="../step-by-step/intro/not-worry.html">
            
                    
                    What not to worry about
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../step-by-step/basic-feathers/readme.html">
            
                <a href="../step-by-step/basic-feathers/readme.html">
            
                    
                    Basic Feathers >>
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.2.1" data-path="../step-by-step/basic-feathers/database-connector.html">
            
                <a href="../step-by-step/basic-feathers/database-connector.html">
            
                    
                    A database connector
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.2" data-path="../step-by-step/basic-feathers/rest-api-server.html">
            
                <a href="../step-by-step/basic-feathers/rest-api-server.html">
            
                    
                    A REST API server
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.3" data-path="../step-by-step/basic-feathers/rest-client.html">
            
                <a href="../step-by-step/basic-feathers/rest-client.html">
            
                    
                    A Feathers REST client
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.4" data-path="../step-by-step/basic-feathers/socket-client.html">
            
                <a href="../step-by-step/basic-feathers/socket-client.html">
            
                    
                    A Feathers websocket client
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.5" data-path="../step-by-step/basic-feathers/ah-ha.html">
            
                <a href="../step-by-step/basic-feathers/ah-ha.html">
            
                    
                    The "ah-ha" moment
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.6" data-path="../step-by-step/basic-feathers/hooks-1.html">
            
                <a href="../step-by-step/basic-feathers/hooks-1.html">
            
                    
                    Hooks, part 1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.7" data-path="../step-by-step/basic-feathers/hooks-2.html">
            
                <a href="../step-by-step/basic-feathers/hooks-2.html">
            
                    
                    Hooks, part 2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.8" data-path="../step-by-step/basic-feathers/real-time.html">
            
                <a href="../step-by-step/basic-feathers/real-time.html">
            
                    
                    Real-time
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../step-by-step/generators/readme.html">
            
                <a href="../step-by-step/generators/readme.html">
            
                    
                    Generators >>
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.3.1" data-path="../step-by-step/generators/app.html">
            
                <a href="../step-by-step/generators/app.html">
            
                    
                    Generating an app
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3.2" data-path="../step-by-step/generators/service.html">
            
                <a href="../step-by-step/generators/service.html">
            
                    
                    Adding a service
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="../step-by-step/what-next.html">
            
                <a href="../step-by-step/what-next.html">
            
                    
                    What's next?
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="../step-by-step/production-ready.html">
            
                <a href="../step-by-step/production-ready.html">
            
                    
                    Is Feathers production ready?
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.6" data-path="../step-by-step/appendix/readme.html">
            
                <a href="../step-by-step/appendix/readme.html">
            
                    
                    Appendix >>
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.6.1" data-path="../step-by-step/appendix/what-is-this.html">
            
                <a href="../step-by-step/appendix/what-is-this.html">
            
                    
                    What is 'this'?
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../chat/readme.html">
            
                <a href="../chat/readme.html">
            
                    
                    Writing a chat room app >>
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../chat/server/readme.html">
            
                <a href="../chat/server/readme.html">
            
                    
                    Server >>
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1.1" data-path="../chat/server/start-server.html">
            
                <a href="../chat/server/start-server.html">
            
                    
                    Starting the server
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.2" data-path="../chat/server/start-front-end.html">
            
                <a href="../chat/server/start-front-end.html">
            
                    
                    Starting the front-end
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.3" data-path="../chat/server/finish-server.html">
            
                <a href="../chat/server/finish-server.html">
            
                    
                    Finishing the server
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.4" data-path="../chat/server/user-mgnt.html">
            
                <a href="../chat/server/user-mgnt.html">
            
                    
                    User management
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../chat/client/readme.html">
            
                <a href="../chat/client/readme.html">
            
                    
                    Client >>
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.2.1" data-path="../chat/client/jQuery.html">
            
                <a href="../chat/client/jQuery.html">
            
                    
                    jQuery client
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.2" data-path="../chat/client/webpack.html">
            
                <a href="../chat/client/webpack.html">
            
                    
                    Using Webpack
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.3" data-path="../chat/client/oauth.html">
            
                <a href="../chat/client/oauth.html">
            
                    
                    OAuth jQuery client
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.4" data-path="../chat/client/other-clients.html">
            
                <a href="../chat/client/other-clients.html">
            
                    
                    Clients for other frameworks
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../chat/what-next.html">
            
                <a href="../chat/what-next.html">
            
                    
                    What's next?
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../adapters/readme.html">
            
                <a href="../adapters/readme.html">
            
                    
                    Adapters >>
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../adapters/redux-services/readme.html">
            
                <a href="../adapters/redux-services/readme.html">
            
                    
                    Redux for Feathers services >>
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../adapters/redux-auth/readme.html">
            
                <a href="../adapters/redux-auth/readme.html">
            
                    
                    Redux for Feathers authentication >>
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="readme.html">
            
                <a href="readme.html">
            
                    
                    Offline
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="strategies.html">
            
                <a href="strategies.html">
            
                    
                    Strategies
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="snapshot.html">
            
                <a href="snapshot.html">
            
                    
                    snapshot
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="realtime.html">
            
                <a href="realtime.html">
            
                    
                    realtime
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="owndata-ownnet.html">
            
                <a href="owndata-ownnet.html">
            
                    
                    own-data & own-net
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5" data-path="syncdata-syncnet.html">
            
                <a href="syncdata-syncnet.html">
            
                    
                    sync-data & sync-net
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.6" data-path="database-records.html">
            
                <a href="database-records.html">
            
                    
                    Database records
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.7" data-path="publications.html">
            
                <a href="publications.html">
            
                    
                    Publications
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.5.8" data-path="filtering.html">
            
                <a href="filtering.html">
            
                    
                    Filtering service events
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.9" data-path="browsers-mobile-devices.html">
            
                <a href="browsers-mobile-devices.html">
            
                    
                    Browsers & mobile devices
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.10" data-path="realtime-setup.html">
            
                <a href="realtime-setup.html">
            
                    
                    realtime setup
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.11" data-path="sync-setup.html">
            
                <a href="sync-setup.html">
            
                    
                    sync-data, sync-net setup
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Filtering service events</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="filtering-service-events">Filtering service events</h1>
<p>Feathers, by default, emits a service event to each client every time a service is mutated,
regardless of who mutated it, or how it was mutated.</p>
<p>Offline-first uses these events to synchronize services while the client is connected to the server.</p>
<ul>
<li>The client mutates a record in the local service.</li>
<li>The replicator automatically mutates that record on the remote service.</li>
<li>That remote mutation may run hooks which further mutate the remote record,
e.g. the <a href="https://docs.feathersjs.com/api/hooks-common.html#setnow" target="_blank"><code>setNow</code></a>
hook is used on the remote service.</li>
<li>The service event emits the new version of the remote service to the client.</li>
<li>The replicator automatically mutates the record on the local service to match the remote&apos;s.</li>
</ul>
<p>You need to act on all events if you are replicating the entire database.
However wouldn&apos;t you want to minimize the number of events sent
if you are replicating only a subset of the database?
Would you want to stop the emitting of events for mutations involving records
from other departments if you are only interested in records from accounting?</p>
<p><strong>The answer is yes ... and no.</strong></p>
<h2 id="state">State</h2>
<p>Filtering requires the server to maintain state,
that is, to save in memory some information for each client.
State is something we try to avoid whenever possible
as it may reduce the number of connections a server can handle.</p>
<p>This may not be of critical a concern for us.
Offline-first is available only for WebSocket clients,
and both socket.io and Primus both retain state.
Feathers uses their state storage mechanisms for its own needs,
offline-first does so as well.</p>
<blockquote>
<p><strong>ProTip</strong> State will likely not be a concern unless you use a <strong>lot</strong> of publications.</p>
</blockquote>
<h2 id="processing-load">Processing load</h2>
<p>More importantly, filtering imposes a processing load on the server
which may or may not be significant.</p>
<p>Assume we are replicating just the records for the accounting department,
and consider this:</p>
<ul>
<li>The remote service has a particular record belonging to the accounting department.</li>
<li>Our client&apos;s local service has replicated that record.</li>
<li>Someone (not us!) mutates that record, moving it to the receiving department.</li>
<li>The client has to be informed of this mutation so it can remove that record from its local service
as it no longer belongs to accounting.</li>
<li>Feathers service event filters only provide the latest contents of a record,
so we would not have enough information to know the event needs to be sent.
We would not know the record used to be from accounting, and no longer is.</li>
</ul>
<p>That&apos;s why, in the general case, the server component of offline-first
must read the before value of the record before mutating it.
The publication function has to be used on both the before and current record contents
to properly determine if the mutation needs to be emitted to a client.</p>
<blockquote>
<p><strong>ProTip</strong> The before record is read just one per mutation, not once per client.</p>
<p><strong>ProTip</strong> The before and current record contents are always checked on the client
as there is negligible performance impact.</p>
</blockquote>
<p>Database <code>get</code> calls are usually fast.
The before record contents may still be cached and quickly available.
This extra <code>get</code> may not impose an excessive extra load on the server,
but it has to be kept in mind.</p>
<blockquote>
<p><strong>ProTip</strong> The extra processing load may not be excessive
unless the server handles a <strong>lot</strong> of clients.</p>
</blockquote>
<h2 id="apps-having-just-one-user">Apps having just one user</h2>
<p>The core data for many mobile applications is unique to the user using the application.
Each record indicates the user the contents are for and, <strong>most importantly</strong>,
the record cannot be transferred to another user.</p>
<p>So if we use a publication like <code>userData</code></p>
<pre><code class="lang-javascript">publications = {
  userData: username =&gt; (data, connection, hook) =&gt; data.username === username
};
</code></pre>
<p>the value of <code>data.username</code> will never change.</p>
<p>This means the server component of the replicator does not need to <code>get</code> the before value
of the record, as the only field the publication function is interested in, <code>data.username</code>,
is always the same on the before and current records.</p>
<p>That is why the replicator&apos;s <code>publication</code> option in this case</p>
<pre><code class="lang-javascript">publication: {
  <span class="hljs-built_in">module</span>: publications, name: <span class="hljs-string">&apos;userData&apos;</span>, params: [username],
  ifServer: <span class="hljs-literal">true</span>, checkBefore: <span class="hljs-literal">false</span>
}
</code></pre>
<p>contains the <code>checkBefore: false</code> option.
It indicates the before record need not be checked for this publication.</p>
<blockquote>
<p><strong>ProTip</strong> The <code>ifServer</code> option determines if the publication also runs on the server.</p>
<p><strong>ProTip</strong> The defaults are <code>ifServer: false</code> and <code>ifBefore: true</code> because this combination
will always produce correct results and is often the most efficient.</p>
</blockquote>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="publications.html" class="navigation navigation-prev " aria-label="Previous page: Publications">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="browsers-mobile-devices.html" class="navigation navigation-next " aria-label="Next page: Browsers & mobile devices">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Filtering service events","level":"1.5.8","depth":2,"next":{"title":"Browsers & mobile devices","level":"1.5.9","depth":2,"path":"offline/browsers-mobile-devices.md","ref":"offline/browsers-mobile-devices.md","articles":[]},"previous":{"title":"Publications","level":"1.5.7","depth":2,"path":"offline/publications.md","ref":"offline/publications.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["feathers-collapsible-menu","heading-anchors","include-codeblock"],"pluginsConfig":{"search":{},"lunr":{"maxIndexSize":1000000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"heading-anchors":{},"highlight":{},"include-codeblock":{},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"feathers-collapsible-menu":{}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css"}},"file":{"path":"offline/filtering.md","mtime":"2017-05-16T14:09:29.849Z","type":"markdown"},"gitbook":{"version":"3.2.2","time":"2017-05-18T18:32:40.023Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-feathers-collapsible-menu/plugin.js"></script>
        
    
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/1.2.1/anchor.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-heading-anchors/anchor-style.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

